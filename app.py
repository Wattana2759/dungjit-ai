from flask import Flask, request, jsonify, render_template, Response
from openai import OpenAI
import os
import requests
from datetime import datetime
from dotenv import load_dotenv
from PIL import Image
import pytesseract
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from db_setup import User, Log
import re

# === ‡πÇ‡∏´‡∏•‡∏î ENV ===
load_dotenv()
app = Flask(__name__)

# === ENV & Setup ===
LINE_ACCESS_TOKEN = os.getenv("LINE_ACCESS_TOKEN")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
LIFF_ID = os.getenv("LIFF_ID")
PUBLIC_URL = os.getenv("PUBLIC_URL", "http://localhost:5000")
client = OpenAI(api_key=OPENAI_API_KEY)
engine = create_engine('sqlite:///db.sqlite')
Session = sessionmaker(bind=engine)
ADMIN_USER = os.getenv("ADMIN_USER", "admin")
ADMIN_PASS = os.getenv("ADMIN_PASS", "1234")

# === Basic Auth ===
def require_basic_auth():
    auth = request.authorization
    if not auth or auth.username != ADMIN_USER or auth.password != ADMIN_PASS:
        return Response("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö", 401, {"WWW-Authenticate": "Basic realm='Admin Access'"})

# === ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
@app.route("/", methods=["GET"])
def index():
    return "‚úÖ Duangjit AI Webhook Server is Running", 200

# === Webhook ‡∏à‡∏≤‡∏Å LINE
@app.route("/webhook", methods=["POST"])
def webhook():
    data = request.json
    if not data or "events" not in data:
        return jsonify(status="ignored"), 200

    for event in data["events"]:
        reply_token = event["replyToken"]
        user_id = event["source"]["userId"]
        if event.get("deliveryContext", {}).get("isRedelivery"):
            continue

        session = Session()
        user = session.get(User, user_id)

        if event["type"] == "follow":
            push_line_message(user_id, "üôè ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà ‡∏î‡∏ß‡∏á‡∏à‡∏¥‡∏ï AI!")
            return jsonify(status="followed"), 200

        if event["type"] == "message":
            try:
                message_text = event["message"]["text"]
            except KeyError:
                send_line_message(reply_token, "‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡πà‡∏∞")
                continue

            if message_text.strip().lower() == "/‡∏î‡∏π‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå":
                if not user:
                    send_line_message(reply_token, "‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô")
                else:
                    send_line_message(reply_token, f"‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß {user.usage or 0} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á / {user.paid_quota or 0} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á")
                continue

            if not user or user.paid_quota is None or user.paid_quota <= 0:
                push_line_message(user_id, "üí∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (1 ‡∏ö‡∏≤‡∏ó = 1 ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°)")
                send_payment_request(user_id)
                send_flex_upload_link(user_id)
                continue

            if user.usage >= user.paid_quota:
                push_line_message(user_id, "‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°")
                send_flex_upload_link(user_id)
                continue

            reply = get_fortune(message_text)
            send_line_message(reply_token, reply)
            user.usage += 1
            session.commit()

    return jsonify(status="ok"), 200

# === ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
def send_line_message(reply_token, text):
    headers = {"Content-Type": "application/json", "Authorization": f"Bearer {LINE_ACCESS_TOKEN}"}
    body = {"replyToken": reply_token, "messages": [{"type": "text", "text": text}]}
    requests.post("https://api.line.me/v2/bot/message/reply", headers=headers, json=body)

def push_line_message(user_id, text):
    headers = {"Content-Type": "application/json", "Authorization": f"Bearer {LINE_ACCESS_TOKEN}"}
    body = {"to": user_id, "messages": [{"type": "text", "text": text}]}
    requests.post("https://api.line.me/v2/bot/message/push", headers=headers, json=body)

def send_payment_request(user_id):
    flex_qr = {
        "type": "flex",
        "altText": "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ",
        "contents": {
            "type": "bubble",
            "hero": {
                "type": "image",
                "url": f"{PUBLIC_URL}/static/qr_promptpay.png",
                "size": "full",
                "aspectRatio": "1:1",
                "aspectMode": "cover"
            },
            "body": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    {"type": "text", "text": "üìå ‡∏™‡πÅ‡∏Å‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏ú‡πà‡∏≤‡∏ô PromptPay", "weight": "bold", "size": "md"},
                    {"type": "text", "text": "‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ‡∏ô‡∏≤‡∏¢ ‡∏ß‡∏±‡∏í‡∏ô‡∏≤ ‡∏à‡∏±‡∏ô‡∏î‡∏≤‡∏´‡∏≤‡∏£", "size": "sm", "wrap": True},
                    {"type": "text", "text": "‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏∞ 1 ‡∏ö‡∏≤‡∏ó ‚Äî ‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á", "size": "sm", "wrap": True}
                ]
            }
        }
    }
    headers = {"Content-Type": "application/json", "Authorization": f"Bearer {LINE_ACCESS_TOKEN}"}
    requests.post("https://api.line.me/v2/bot/message/push", headers=headers, json={"to": user_id, "messages": [flex_qr]})

def send_flex_upload_link(user_id):
    flex_message = {
        "type": "flex",
        "altText": "‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏î‡∏ß‡∏á‡∏à‡∏¥‡∏ï AI ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏•‡∏∞ 1 ‡∏ö‡∏≤‡∏ó ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô!",
        "contents": {
            "type": "bubble",
            "hero": {
                "type": "image",
                "url": f"{PUBLIC_URL}/static/banner.jpg",
                "size": "full",
                "aspectRatio": "16:9",
                "aspectMode": "cover"
            },
            "body": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    {
                        "type": "text",
                        "text": "‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏î‡∏ß‡∏á‡∏à‡∏¥‡∏ï ‡∏´‡∏°‡∏≠‡∏î‡∏π AI",
                        "weight": "bold",
                        "size": "md",
                        "wrap": True
                    }
                ]
            },
            "footer": {
                "type": "box",
                "layout": "vertical",
                "spacing": "sm",
                "contents": [
                    {
                        "type": "button",
                        "style": "primary",
                        "color": "#06c755",
                        "action": {
                            "type": "uri",
                            "label": "‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ",
                            "uri": f"{PUBLIC_URL}/upload-slip-liff"
                        }
                    }
                ]
            }
        }
    }
    headers = {"Content-Type": "application/json", "Authorization": f"Bearer {LINE_ACCESS_TOKEN}"}
    requests.post("https://api.line.me/v2/bot/message/push", headers=headers, json={"to": user_id, "messages": [flex_message]})

# === Fortune with GPT
def get_fortune(message):
    prompt = f"""‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏´‡∏°‡∏≠‡∏î‡∏π‡πÑ‡∏ó‡∏¢‡πÇ‡∏ö‡∏£‡∏≤‡∏ì ‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏ç‡∏≤‡∏ì‡∏´‡∏¢‡∏±‡πà‡∏á‡∏£‡∏π‡πâ ‡∏û‡∏π‡∏î‡∏à‡∏≤‡πÄ‡∏Ñ‡∏£‡πà‡∏á‡∏Ç‡∏£‡∏∂‡∏° ‡∏™‡∏∏‡∏†‡∏≤‡∏û ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏ß‡∏á‡∏ä‡∏∞‡∏ï‡∏≤ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å ‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ù‡∏±‡∏ô

‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ñ‡∏≤‡∏°: "{message}"
‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏≠‡∏î‡∏π:"""
    try:
        response = client.chat.completions.create(model="gpt-4o", messages=[{"role": "user", "content": prompt}])
        return response.choices[0].message.content.strip()
    except Exception as e:
        print("‚ùå OpenAI Error:", e)
        return "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏°‡∏≠‡∏î‡∏π AI ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏£‡∏∞‡∏ö

